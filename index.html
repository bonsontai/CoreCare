<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreCare訓練平台</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- 基礎設定 --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-color: #f4f7f6;
            --text-color: #333;
            --nav-bg: #fff;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* --- 導覽列 (Navbar) --- */
        header {
            background-color: var(--nav-bg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
            letter-spacing: 1px;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 20px;
            margin: 0;
            padding: 0;
            align-items: center;
        }

        .nav-links li {
            position: relative;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: color 0.3s;
            cursor: pointer;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: var(--primary-color);
        }

        /* 下拉選單 (Dropdown) */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            top: 100%;
            left: 0;
            z-index: 1;
            border-radius: 4px;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        /* 漢堡選單按鈕 (Mobile) */
        .hamburger {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* --- 主內容區塊 --- */
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            min-height: 80vh;
        }

        .section {
            display: none;
            /* 預設隱藏所有區塊 */
            animation: fadeIn 0.5s;
        }

        .section.active-section {
            display: block;
            /* 顯示當前區塊 */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* --- 首頁樣式 --- */
        .hero {
            text-align: center;
            padding: 5rem 1rem;
            background: linear-gradient(135deg, #007bff 0%, #00d2ff 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        /* --- 個人頁面樣式 --- */
        .personal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .filter-select {
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .data-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
        }

        .data-list p {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .data-list span {
            font-weight: bold;
            color: var(--primary-color);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* --- 訓練頁面樣式 --- */
        .training-card {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            text-align: center;
            margin-top: 2rem;
        }

        .training-result h3 {
            color: var(--primary-color);
            font-size: 2rem;
            margin: 10px 0;
        }

        .level-badge {
            background-color: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            vertical-align: middle;
        }

        /* --- 響應式設計 (RWD) --- */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
                flex-direction: column;
                width: 100%;
                background-color: white;
                position: absolute;
                top: 60px;
                left: 0;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .nav-links.active {
                display: flex;
            }

            .nav-links li {
                width: 100%;
                text-align: center;
            }

            .dropdown-content {
                position: static;
                box-shadow: none;
                background-color: #f9f9f9;
                display: none;
                /* Mobile預設摺疊 */
            }

            .dropdown.active .dropdown-content {
                display: block;
            }

            .hamburger {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <header>
        <nav>
            <a href="#" class="logo" onclick="navigateTo('home')">CoreCare</a>
            <div class="hamburger" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a onclick="navigateTo('home')">首頁</a></li>
                <li><a onclick="navigateTo('personal')">我的數據</a></li>
                <li class="dropdown" onclick="toggleDropdown(this)">
                    <a>開始訓練 <i class="fas fa-caret-down"></i></a>
                    <div class="dropdown-content">
                        <a onclick="loadTraining('squat')">深蹲訓練</a>
                        <a onclick="loadTraining('kettlebell')">壺鈴訓練</a>
                        <a onclick="loadTraining('sitting')">坐姿訓練</a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="home" class="section active-section">
            <div class="hero">
                <h1>歡迎來到 CoreCare</h1>
                <p>您的個人化健身訓練夥伴</p>
                <br>
                <p>專為肌少症患者打造的健身平台</p>
                <button onclick="navigateTo('personal')"
                    style="margin-top: 20px; padding: 10px 20px; cursor: pointer; border: none; background: white; color: #007bff; border-radius: 5px; font-weight: bold;">查看我的數據</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div class="data-card">
                    <h3><i class="fas fa-bullseye"></i> 精準追蹤</h3>
                    <p>實時監控您的訓練姿勢，提供即時反饋。</p>
                </div>
                <div class="data-card">
                    <h3><i class="fas fa-chart-line"></i> 數據分析</h3>
                    <p>透過雷達圖分析您的投入度與掌握度。</p>
                </div>
                <div class="data-card">
                    <h3><i class="fas fa-dumbbell"></i> 動態調整</h3>
                    <p>根據您的表現自動調整訓練強度。</p>
                </div>
            </div>
        </section>

        <section id="personal" class="section">
            <div class="personal-header">
                <h2>個人訓練數據</h2>
                <select id="statsType" class="filter-select" onchange="updatePersonalData()">
                    <option value="squat">深蹲數據</option>
                    <option value="kettlebell">壺鈴數據</option>
                    <option value="sitting">坐姿數據</option>
                </select>
            </div>

            <div class="stats-grid">
                <div class="data-card">
                    <h3>詳細數據</h3>
                    <div class="data-list" id="dataListContent">
                    </div>
                </div>

                <div class="data-card" style="margin-top: 2rem; overflow-x: auto;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3><i class="fas fa-history"></i> 歷史訓練紀錄</h3>
                        <span style="font-size: 0.9rem; color: #666;">顯示最近 50 筆</span>
                    </div>
                    <div id="historyTableContainer">
                    </div>
                </div>

                <div class="data-card">
                    <h3>能力分析雷達圖</h3>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="training" class="section">
            <iframe id="trainingFrame" name="trainingFrame"
                style="width: 100%; height: 85vh; border: none; border-radius: 10px; background-color: #fff;" src="">
            </iframe>
        </section>
    </main>

    <script src="person_radarchart.js"></script>

    <script>
        // --- 全域變數 ---
        let globalCSVData = [];
        let myRadarChart = null;

        // --- 設定與對照表 ---
        const trainingPaths = {
            squat: { column: 'last_squats_train_level', folder: 'squats' },
            kettlebell: { column: 'last_advances_train_level', folder: 'advances' },
            sitting: { column: 'last_sitting_train_level', folder: 'sitting' }
        };

        const levelFileMap = {
            'lower': 'lower.html',
            'middle': 'middle.html',
            'upper': 'upper.html',
            'upperPro': 'upper.html'
        };

        const displayMap = {
            'squat': '深蹲', 'kettlebell': '壺鈴', 'sitting': '坐姿',
            'lower': '初階', 'middle': '中階', 'upper': '高階', 'upperPro': '進階',
            'squats': '深蹲', 'advances': '壺鈴' // 對應 CSV Posen 內容
        };

        // 表格欄位標頭翻譯
        const HEADER_MAP = {
            'Tid': '時間',
            'Posen': '訓練項目',
            'Level': '結果',
            'Squats_FE': '深蹲錯誤', 'Squats_TE': '深蹲正確',
            'Advances_FE': '壺鈴錯誤', 'Advances_TE': '壺鈴正確',
            'Sitting_FE': '坐姿錯誤', 'Sitting_TE': '坐姿正確',
            'last_squats_train_level': '深蹲建議',
            'last_advances_train_level': '壺鈴建議',
            'last_sitting_train_level': '坐姿建議'
        };

        // 定義每種訓練要顯示哪些欄位
        const TABLE_COLUMNS = {
            'squat': ['Tid', 'Level', 'Squats_FE', 'Squats_TE', 'last_squats_train_level'],
            'kettlebell': ['Tid', 'Level', 'Advances_FE', 'Advances_TE', 'last_advances_train_level'],
            'sitting': ['Tid', 'Level', 'Sitting_FE', 'Sitting_TE', 'last_sitting_train_level']
        };

        // --- 1. 讀取 CSV 資料庫 (已改用 API) ---
        function fetchCsvData() {
            // ✅ 使用 /get-csv API 讀取，避免快取
            const csvUrl = "/get-csv?t=" + Date.now();
            
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    console.log("CSV 讀取成功", results.data.length + " 筆資料");
                    globalCSVData = results.data;
                    if (document.getElementById('personal').classList.contains('active-section')) {
                        updatePersonalData();
                    }
                },
                error: function (err) {
                    console.error("無法讀取 CSV", err);
                }
            });
        }

        // --- 2. 核心：訓練跳轉邏輯 (iframe 模式 + 往回搜尋) ---
        function loadTraining(typeKey) {
            const config = trainingPaths[typeKey];
            if (!config) return alert("未知的訓練類型");

            const csvUrl = "/get-csv?t=" + Date.now();

            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    const rows = results.data;
                    let suggestion = 'middle'; // 預設

                    // ✅ 往回搜尋最近的有效紀錄
                    for (let i = rows.length - 1; i >= 0; i--) {
                        let val = rows[i][config.column];
                        if (val && val.trim() !== '') {
                            val = val.trim();
                            if (levelFileMap[val]) {
                                suggestion = val;
                                console.log(`[系統] 找到最新有效紀錄 (Row ${i}): ${suggestion}`);
                                break;
                            }
                        }
                    }

                    const targetUrl = `${config.folder}/${levelFileMap[suggestion]}`;
                    console.log(`[系統] 最終載入訓練: ${targetUrl} (等級: ${suggestion})`);

                    const iframe = document.getElementById('trainingFrame');
                    iframe.src = targetUrl;
                    navigateTo('training');
                },
                error: function () {
                    console.error("CSV 讀取失敗，使用預設值 middle");
                    document.getElementById('trainingFrame').src = `${config.folder}/middle.html`;
                    navigateTo('training');
                }
            });
        }

        // --- 3. 更新個人頁面 (含修正後的建議等級邏輯) ---
        function updatePersonalData() {
            if (globalCSVData.length === 0) return;

            const typeKey = document.getElementById('statsType').value;

            // 定義篩選規則
            let csvPosenName = '';
            if (typeKey === 'squat') csvPosenName = 'squats';
            else if (typeKey === 'kettlebell') csvPosenName = 'advances';
            else if (typeKey === 'sitting') csvPosenName = 'sitting';

            const filteredRows = globalCSVData.filter(row => {
                if (!row['Posen']) return false;
                if (typeKey === 'squat') return row['Posen'].includes('squats') || row['Posen'] === 'lower' || row['Posen'] === 'middle';
                if (typeKey === 'kettlebell') return row['Posen'].includes('advances') || row['Posen'] === 'upper';
                if (typeKey === 'sitting') return row['Posen'].includes('sitting');
                return false;
            });

            const latest = filteredRows.length > 0 ? filteredRows[filteredRows.length - 1] : {};

            // A. 繪製雷達圖
            let radarScores = [0, 0, 0, 0];
            if (typeof calculateRadarData === 'function') {
                const radarResult = calculateRadarData(filteredRows, csvPosenName);
                radarScores = radarResult.scores;
            }
            renderMyRadarChart(radarScores);

            // B. 更新詳細數據 (✅ 修正：往回搜尋有效建議)
            let feKey = '', teKey = '', levelKey = '';
            if (typeKey === 'squat') { feKey = 'Squats_FE'; teKey = 'Squats_TE'; levelKey = 'last_squats_train_level'; }
            else if (typeKey === 'kettlebell') { feKey = 'Advances_FE'; teKey = 'Advances_TE'; levelKey = 'last_advances_train_level'; }
            else { feKey = 'Sitting_FE'; teKey = 'Sitting_TE'; levelKey = 'last_sitting_train_level'; }

            // 搜尋最近一次有效的建議等級
            let suggestionRaw = 'middle';
            for (let i = filteredRows.length - 1; i >= 0; i--) {
                const val = filteredRows[i][levelKey];
                if (val && val.trim() !== '') {
                    suggestionRaw = val.trim();
                    break;
                }
            }

            const listHtml = `
                <p>最近訓練: <span>${latest['Tid'] ? new Date(latest['Tid']).toLocaleString() : '無紀錄'}</span></p>
                <p>訓練項目: <span>${displayMap[typeKey]}</span></p>
                <p>最近結果: <span>${latest['Level'] || '尚未訓練'}</span></p>
                <p>錯誤次數: <span style="color:red">${latest[feKey] || 0}</span></p>
                <p>正確次數: <span style="color:green">${latest[teKey] || 0}</span></p>
                <p>系統建議: <span style="color:#007bff; font-size:1.1em; font-weight:bold">${displayMap[suggestionRaw] || suggestionRaw}</span></p>
            `;
            document.getElementById('dataListContent').innerHTML = listHtml;

            // C. 渲染歷史表格
            renderHistoryTable(filteredRows, typeKey);
        }

        // --- 歷史表格渲染函式 ---
        function renderHistoryTable(rows, typeKey) {
            const container = document.getElementById('historyTableContainer');
            container.innerHTML = '';

            if (rows.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px;">尚無此項目的訓練紀錄。</p>';
                return;
            }

            const displayRows = [...rows].reverse().slice(0, 50);
            const columns = TABLE_COLUMNS[typeKey];

            let tableHtml = '<table style="width:100%; border-collapse: collapse; font-size: 0.95rem;">';
            tableHtml += '<thead style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;"><tr>';
            columns.forEach(col => {
                tableHtml += `<th style="padding: 12px; text-align: left;">${HEADER_MAP[col] || col}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            displayRows.forEach(row => {
                tableHtml += '<tr style="border-bottom: 1px solid #eee;">';
                columns.forEach(col => {
                    let val = row[col] || '-';
                    if (col === 'Tid') {
                        try { val = new Date(val).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); } catch (e) { }
                    } else if (col.startsWith('last_')) {
                        val = displayMap[val] || val;
                    }
                    let style = 'padding: 12px;';
                    if (col.includes('_FE') && val != '0' && val != '-') style += 'color: red; font-weight:bold;';
                    if (col.includes('_TE') && val != '0' && val != '-') style += 'color: green; font-weight:bold;';
                    tableHtml += `<td style="${style}">${val}</td>`;
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';
            container.innerHTML = tableHtml;
        }

        // --- 圖表繪製 ---
        function renderMyRadarChart(dataValues) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (myRadarChart) myRadarChart.destroy();

            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['姿勢準確度', '等級掌握度', '穩定性分數', '總體投入度'],
                    datasets: [{
                        label: '能力指標',
                        data: dataValues,
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(0, 123, 255, 1)'
                    }]
                },
                options: {
                    scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 100 } },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // --- 頁面切換 ---
        function navigateTo(pageId) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active-section'));
            document.getElementById(pageId).classList.add('active-section');

            const navLinks = document.getElementById('navLinks');
            if (navLinks) navLinks.classList.remove('active');

            if (pageId !== 'training') {
                const iframe = document.getElementById('trainingFrame');
                if (iframe && iframe.src) iframe.src = "";
            }

            if (pageId === 'personal') {
                fetchCsvData();
            }
        }

        function toggleMenu() {
            document.getElementById('navLinks').classList.toggle('active');
        }
        function toggleDropdown(element) {
            if (window.innerWidth <= 768) element.classList.toggle('active');
        }

        // 初始化
        window.onload = function () {
            fetchCsvData();
            navigateTo('home');
        };
    </script>
</body>

</html>